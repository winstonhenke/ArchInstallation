#!/bin/bash

 function myEval { 
    #TODO - look into not using eval
    #TODO - pull this out into a shared resource
    #https://stackoverflow.com/questions/17529220/why-should-eval-be-avoided-in-bash-and-what-should-i-use-instead 
    red=`tput setaf 1`
    green=`tput setaf 2`
    reset=`tput sgr0`

    printf "Running eval: %s\n" "${1}"
    eval ${1}

    if [[ $? != 0 ]]; then
        printf "Command %sfailed%s!!\nExiting script...\n\n" "${red}" "${reset}"
        exit 1
    else
        printf "Command completed %ssuccessfully%s\n\n"   "${green}" "${reset}"
    fi
}


HOST=myhostname
USERNAME=testuser
HOME_DIR="/home/${USERNAME}"
SWAP_SIZE=4G
echo DISK="$1", HOST="$HOST", USERNAME="$USERNAME", HOME_DIR="$HOME_DIR"

# grub as a bootloader
grub-install --target=i386-pc --recheck "$1"
# This makes the grub timeout 0, it's faster than 5 :)
#sudo sed -i 's/GRUB_TIMEOUT=5/GRUB_TIMEOUT=0/g' /etc/default/grub
#Get root partition uuid
fs_uuid=$(lsblk -no UUID /dev/sdb2)
printf "UUID for /dev/sdb2 is: %s   \n" "${fs_uuid}"
sed -i '/GRUB_CMDLINE_LINUX=/c\GRUB_CMDLINE_LINUX="cryptdevice=UUID=${fs_uuid}:cryptroot root=/dev/mapper/cryptroot"' /etc/default/grub
myEval "grep GRUB_CMDLINE_LINUX /etc/default/grub"
myEval "grub-mkconfig -o /boot/grub/grub.cfg"

# run these following essential service by default
myEval "systemctl enable dhcpcd.service"
echo "$HOST" > /etc/hostname

# adding your normal user with additional wheel group so can sudo
myEval "useradd -m -G wheel -p test -s /bin/bash testuser"

# adjust your timezone here
myEval "hwclock --systohc"

myEval "echo en_US.UTF-8 UTF-8 > /etc/locale.gen"
myEval "echo LANG=en_US.UTF-8 > /etc/locale.conf"
myEval "locale-gen"

# because we are using ssh keys, make sudo not ask for passwords
echo 'root ALL=(ALL) ALL' > /etc/sudoers
echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers


#Do Initramfs stuff here
sed -i 's/^HOOKS.*/HOOKS="base udev autodetect modconf keyboard block encrypt lvm2 filesystems keyboard fsck"/' /etc/mkinitcpio.conf
myEval "grep HOOKS /etc/mkinitcpio.conf"
myEval "mkinitcpio -p linux"

printf "setting password for root... \n"
myEval "passwd"
myEval "exit"